<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenplay YAML Executor</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui/1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <button class="btn btn-primary" id="showOutputButton">Show Execution Output</button>
        <button class="btn btn-primary" id="showYamlButton">Show Screenplay</button>
        <button class="btn btn-primary" id="showCommandListButton">Show Command List</button> <!-- Command List Button -->
        <button class="btn btn-primary" id="showCommandInputButton">Command Input</button>
        <button class="btn btn-primary" id="showMetricsButton">System Metrics</button>
        <button class="btn btn-primary" id="goToGeneratorButton">Generator</button>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
    </div>

    <div class="main-container">
        <!-- Command List Panel -->
        <div id="commandListPanel" class="command-list">
            <div class="window-controls">
                <button class="btn btn-secondary" id="closeCommandListButton">x</button>
            </div>
            <h3>Commands</h3>
            <button class="command-button">AWS Create Listener</button>
            <button class="command-button">AWS Internet Gateway</button>
            <button class="command-button">AWS NAT Gateway</button>
            <button class="command-button">AWS Subnet</button>
            <button class="command-button">Check Nodes</button>
            <button class="command-button">Configure Instance</button>
            <button class="command-button">Create EKS Cluster</button>
            <button class="command-button">Create EKS Nodegroup</button>
            <button class="command-button">Create Elastic IP</button>
            <button class="command-button">Create Load Balancer</button>
            <button class="command-button">Create Route Table</button>
            <button class="command-button">Create S3 Bucket</button>
            <button class="command-button">Create Security Group</button>
            <button class="command-button">Create Target Group</button>
            <button class="command-button">Register Targets</button>
            <button class="command-button">Request SSL Certificate</button>
        </div>

        <!-- Command Input Panel -->
        <div id="commandInputPanel" class="command-bar mt-4">
            <div class="window-controls">
                <button class="btn btn-secondary" id="minimizeCommandInputButton">-</button>
                <button class="btn btn-secondary" id="maximizeCommandInputButton">[]</button>
                <button class="btn btn-secondary" id="closeCommandInputButton">x</button>
            </div>
            <div class="input-group">
                <input type="text" id="command_input" name="command_input" class="form-control" placeholder="Enter your command here..." />
                <div class="input-group-append">
                    <button class="btn btn-success" type="button">Submit</button>
                </div>
            </div>
        </div>

        <!-- System Metrics Panel -->
        <div id="metricsPanel" class="metrics-panel">
            <div class="window-controls">
                <button class="btn btn-secondary" id="minimizeMetricsButton">-</button>
                <button class="btn btn-secondary" id="maximizeMetricsButton">[]</button>
                <button class="btn btn-secondary" id="closeMetricsButton">x</button>
            </div>
            <h3>System Metrics</h3>
            <div id="cpuDetails" class="metric-details">Total CPUs: --, CPU Usage: --%</div>
            <canvas id="cpuChart"></canvas>
            <div id="memoryDetails" class="metric-details">Total Memory: --MB, Memory Usage: --%</div>
            <canvas id="memoryChart"></canvas>
            <div id="diskDetails" class="metric-details">Total Disk: --GB, Disk Usage: --%</div>
            <canvas id="diskChart"></canvas>
        </div>

        <!-- Execution Output Panel -->
        <div id="executionOutput" class="execution-output">
            <div class="window-controls">
                <button class="btn btn-secondary" id="minimizeButton">-</button>
                <button class="btn btn-secondary" id="maximizeButton">[]</button>
                <button class="btn btn-secondary" id="closeButton">x</button>
                <button class="btn btn-warning" id="clearOutputButton">Clear</button> <!-- Clear Button -->
            </div>
            <div id="output-content" class="terminal-output"></div>
        </div>

        <!-- YAML Panel -->
        <div class="main-container">
            <!-- YAML Panel -->
            <div id="yamlPanel" class="yaml-panel">
                <div class="window-controls">
                    <button class="btn btn-secondary" id="minimizeYamlButton">-</button>
                    <button class="btn btn-secondary" id="maximizeYamlButton">[]</button>
                    <button class="btn btn-secondary" id="closeYamlButton">x</button>
                </div>
                <form id="screenplay-form" method="POST" action="" onsubmit="return executeScreenplay();">
                    <div class="form-group">
                        <label for="access_point">Access Point:</label>
                        <select id="access_point" name="access_point" class="form-control">
                            <option value="default">Default</option>
                            <option value="dev">Development</option>
                            <option value="prod">Production</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="yaml_content">YAML Content:</label>
                        <textarea id="yaml_content" name="yaml_content" class="form-control" rows="20" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="command_parameters">Additional Parameters:</label>
                        <input type="text" id="command_parameters" name="command_parameters" class="form-control" placeholder="Enter additional parameters (e.g., --add-remote, --create-remote)">
                    </div>
                    <!-- Execution Button for YAML -->
                    <button type="submit" class="btn btn-primary btn-block">Execute Screenplay</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Include jQuery, Popper.js, and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize draggable and resizable for panels
            $("#executionOutput").draggable().resizable().hide();
            $("#yamlPanel").draggable().resizable().hide();
            $("#commandInputPanel").draggable().resizable().hide();
            $("#metricsPanel").draggable().resizable().hide();
            $("#commandListPanel").draggable().resizable().hide();

            // Toolbar buttons to show the panels
            $('#showOutputButton').click(function () {
                $('#executionOutput').show();
            });

            $('#showYamlButton').click(function () {
                $('#yamlPanel').show();
            });

            $('#showCommandInputButton').click(function () {
                $('#commandInputPanel').show();
            });

            $('#showMetricsButton').click(function () {
                $('#metricsPanel').show();
            });

            $('#showCommandListButton').click(function () {
                $('#commandListPanel').show();
            });

            // Redirect to the generator page when the button is clicked
            $('#goToGeneratorButton').click(function () {
                window.location.href = "{{ url_for('file_generator') }}";
            });

            // Control buttons for the Command List
            $('#closeCommandListButton').click(function() {
                $('#commandListPanel').hide();
            });

            // Control buttons for the execution output panel
            $('#minimizeButton').click(function() {
                $('#executionOutput').hide();
            });

            $('#maximizeButton').click(function() {
                $('#executionOutput').toggleClass('maximized');
            });

            $('#closeButton').click(function() {
                $('#executionOutput').hide();
            });

            $('#clearOutputButton').click(function() {
                $('#output-content').html(''); // Clear the execution output
            });

            // Control buttons for the YAML panel
            $('#minimizeYamlButton').click(function() {
                $('#yamlPanel').hide();
            });

            $('#maximizeYamlButton').click(function() {
                $('#yamlPanel').toggleClass('maximized');
            });

            $('#closeYamlButton').click(function() {
                $('#yamlPanel').hide();
            });

            // Control buttons for the Command Input
            $('#minimizeCommandInputButton').click(function() {
                $('#commandInputPanel').hide();
            });

            $('#maximizeCommandInputButton').click(function() {
                $('#commandInputPanel').toggleClass('maximized');
            });

            $('#closeCommandInputButton').click(function() {
                $('#commandInputPanel').hide();
            });

            // Control buttons for the System Metrics panel
            $('#minimizeMetricsButton').click(function() {
                $('#metricsPanel').hide();
            });

            $('#maximizeMetricsButton').click(function() {
                $('#metricsPanel').toggleClass('maximized');
            });

            $('#closeMetricsButton').click(function() {
                $('#metricsPanel').hide();
            });

            // Function to fetch and update system metrics
            function updateMetrics() {
                $.getJSON("{{ url_for('metrics') }}", function(data) {
                    // Update CPU chart
                    cpuChart.data.datasets[0].data.push(data.cpu_percent);
                    if (cpuChart.data.datasets[0].data.length > 20) {
                        cpuChart.data.datasets[0].data.shift();
                    }
                    cpuChart.update();

                    // Update Memory chart
                    memoryChart.data.datasets[0].data.push(data.memory_percent);
                    if (memoryChart.data.datasets[0].data.length > 20) {
                        memoryChart.data.datasets[0].data.shift();
                    }
                    memoryChart.update();

                    // Update Disk chart
                    diskChart.data.datasets[0].data.push(data.disk_percent);
                    if (diskChart.data.datasets[0].data.length > 20) {
                        diskChart.data.datasets[0].data.shift();
                    }
                    diskChart.update();

                    // Update system details
                    $('#cpuDetails').text(`Total CPUs: ${data.cpu_count}, CPU Usage: ${data.cpu_percent}%`);
                    $('#memoryDetails').text(`Total Memory: ${data.memory_total}MB, Memory Usage: ${data.memory_percent}%`);
                    $('#diskDetails').text(`Total Disk: ${data.disk_total}GB, Disk Usage: ${data.disk_percent}%`);
                });
            }

            // Set up the charts
            var ctxCpu = document.getElementById('cpuChart').getContext('2d');
            var cpuChart = new Chart(ctxCpu, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        fill: true,
                    }]
                },
                options: {
                    scales: {
                        x: {
                            grid: {
                                display: true,
                            },
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: true,
                            },
                        }
                    }
                }
            });

            var ctxMemory = document.getElementById('memoryChart').getContext('2d');
            var memoryChart = new Chart(ctxMemory, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'Memory Usage (%)',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        fill: true,
                    }]
                },
                options: {
                    scales: {
                        x: {
                            grid: {
                                display: true,
                            },
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: true,
                            },
                        }
                    }
                }
            });

            var ctxDisk = document.getElementById('diskChart').getContext('2d');
            var diskChart = new Chart(ctxDisk, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'Disk Usage (%)',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: true,
                    }]
                },
                options: {
                    scales: {
                        x: {
                            grid: {
                                display: true,
                            },
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: true,
                            },
                        }
                    }
                }
            });

            // Update metrics every 5 seconds
            setInterval(updateMetrics, 5000);

            // Form submission handling
            $('#screenplay-form').on('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                $('#output-content').html(""); // Clear previous output

                var form = $(this);
                var formData = form.serialize();

                $.ajax({
                    url: form.attr('action'),
                    method: form.attr('method'),
                    data: formData,
                    xhrFields: {
                        onprogress: function(e) {
                            var newResponse = e.currentTarget.response;
                            $('#output-content').html(newResponse);
                            $('#output-content').scrollTop($('#output-content')[0].scrollHeight); // Scroll to the bottom
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
